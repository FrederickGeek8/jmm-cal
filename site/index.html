<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>JMM 2026 Calendar Converter</title>
    <meta name="description"
        content="A tool for converting your Joint Mathematics Meeting personal agenda to a normal calendar file." />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script src="https://unpkg.com/ical.js@2.2.1/dist/ical.es5.min.cjs"
        integrity="sha384-ju8ozm4ZyuCTzjb4fvLmPUASX0zfc5jLOvyN9wadLx23y965jxfdbKTPMIeLrliP"
        crossorigin="anonymous"></script>

    <style type="text/css" media="screen">
        textarea {
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;

            max-width: 100%;
        }

        body {
            background: white;
            color: black;
            max-width: 850px;
        }

        .h-event {
            border: 1px solid black;
            padding: 5px;
            margin: 10px;
        }

        @media (prefers-color-scheme: dark) {
            html {
                filter: invert(1);
            }
        }
    </style>

</head>

<body>
    <noscript>
        <p style="color: red;">
            Javascript is required for this website to function.

            All computations are done client-side and no data is sent to any servers.
        </p>
    </noscript>
    <h1>A Tool For Converting Joint Mathematics Meeting Schedules</h1>
    <p>Use this tool to convert your personal agenda for the Joint Mathematics Meeting to a iCal format, so it can be
        imported into Google Calendar, Apple Calendar, and more. The JMM 2026 mobile app only supports emailing the
        agenda you designed as a PDF, so this tool is meant to bridge the gap between the app and your calendar.</p>
    <p><strong>Instructions:</strong> Open your PDF and "Select All" text and paste it below. Click "Generate iCal File"
        and a download link for your iCal file will be generated. All data is converted in the safety of your own
        browser,
        and no data is sent to any server.</p>
    <p>Contact me, <a href="https://freddy.us/contact/" rel="me">Frederick Morlock</a>, if you run into any problems.
        The code is
        also available on <a href="https://github.com/FrederickGeek8/jmm-cal">Github</a>.</p>
    <p id="error" style="display: none; color: red;"></p>
    <label for="jmm-cal" style="display: block; margin-bottom: 10px;"><strong>Copy/paste <em>all</em> of the text from
            your emailed JMM schedule below. It should
            start with
            "JMM 2026".</strong></label>
    <textarea id="jmm-cal" name="jmm-cal" rows="20" cols="100"
        placeholder="Copy-paste the JMM PDF contents here. It should begin with 'JMM 2026' since you copied the headline of the PDF too."
        style="max-width:100%;"></textarea>
    <br />
    <input type="checkbox" name="guess" id="guess" checked disabled />
    <label for="guess">Attempt to fetch end-times for events <span id="loading" style="text-transform: italics;">
            (Loading...)</span></label>
    <br />
    <button id="generate">Generate iCal File</button>
    <h3><a id="download" style="display: none"><strong>Click here to download your <code>ical</code> file.</strong></a>
    </h3>

    <h2>Limitations</h2>
    <ul>
        The PDF generation (and parsing) is not bullet-proof. There could be errors in my code and edge-cases I have not
        accounted for. Let me know if you run into any issues.
    </ul>

    <div id="events">
        <h2>Parsed Events</h2>
        <div id="parsed-events"><em>Input your PDF contents above to show the parsed events.</em></div>
    </div>

    <script type="text/javascript">
        const error_elem = document.getElementById("error");
        let resource_ready = false;
        let data_json = null;


        async function getData() {
            const url = "/resources/jmm2026-parsed-agenda.min.json"
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Response status: ${response.status}`);
                }

                data_json = await response.json();
                resource_ready = true;

                document.getElementById("loading").remove();
                document.getElementById("guess").disabled = false;

                console.debug("Fetched JMM agenda");
            } catch (error) {
                console.error(error.message);
                document.getElementById("guess").checked = false;
            }
        }

        getData();

        // Thanks https://stackoverflow.com/a/6248722
        function generateUID() {
            // I generate the UID from two parts here
            // to ensure the random number provide enough bits.
            var firstPart = (Math.random() * 46656) | 0;
            var secondPart = (Math.random() * 46656) | 0;
            firstPart = ("000" + firstPart.toString(36)).slice(-3);
            secondPart = ("000" + secondPart.toString(36)).slice(-3);
            return firstPart + secondPart;
        }

        function writeError(msg) {
            console.error(msg);

            error_elem.innerText = `Error: ${msg}`;
            error_elem.style.display = "block";
        }

        function generateLink(events) {
            var comp = new ICAL.Component(['vcalendar', [], []]);
            comp.updatePropertyWithValue('prodid', '-//JMM Calendar');
            comp.toString();

            events.forEach((event) => {
                var vevent = new ICAL.Component('vevent');
                var cal_event = new ICAL.Event(vevent);

                cal_event.summary = event["title"];
                cal_event.description = event["presentedBy"];
                cal_event.location = event["location"];
                cal_event.uid = generateUID();
                cal_event.startDate = ICAL.Time.fromJSDate(new Date(Date.parse(`${event["date"]} ${event["start_time"]} EST`)));
                if (event["end_time"] != null) {
                    cal_event.endDate = ICAL.Time.fromJSDate(new Date(Date.parse(`${event["date"]} ${event["end_time"]} EST`)));
                }

                comp.addSubcomponent(vevent);
            });

            var dl_element = document.getElementById("download");
            dl_element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(comp.toString()));
            dl_element.setAttribute('download', "JMM 2026 Agenda.ics");
            dl_element.style.display = 'initial';
        }

        function displayEvents(events) {
            // https://microformats.org/wiki/h-event#Example
            const container = document.createElement('div');

            events.forEach(event => {
                const eventDiv = document.createElement('div');
                eventDiv.className = 'h-event';

                const title = document.createElement('h3');
                title.className = 'p-name';
                title.textContent = event["title"];

                const time = document.createElement('time');
                time.className = 'dt-start';
                time.setAttribute('datetime', (new Date(`${event["date"]} ${event["start_time"]} EST`)).toISOString());
                time.textContent = `${event.date} at ${event.start_time}`;

                const presenters = document.createElement('p');
                presenters.className = 'p-organizer';
                presenters.textContent = `Presented by: ${event.presentedBy}`;

                const location = document.createElement('p');
                location.className = 'p-location';
                location.textContent = event.location;

                eventDiv.appendChild(title);
                eventDiv.appendChild(time);
                if (event.end_time != null) {
                    const end_time = document.createElement('end_time');
                    end_time.className = 'dt-start';
                    end_time.setAttribute('datetime', (new Date(`${event["date"]} ${event["end_time"]} EST`)).toISOString());
                    end_time.textContent = ` to ${event.end_time}`;
                    eventDiv.appendChild(end_time);
                }

                eventDiv.appendChild(presenters);
                eventDiv.appendChild(location);

                container.appendChild(eventDiv);
            });

            document.getElementById("parsed-events").replaceWith(container);
        }

        function parse_contents(e) {
            error_elem.text = "";
            error_elem.style.display = "none";
            var contents = document.getElementById("jmm-cal").value;
            // validate first line is JMM 2026
            if (contents.slice(0, contents.indexOf("\n")) != "JMM 2026") {
                writeError("The first line should read JMM 2026");
                return;
            }

            // normalize dates. Sometimes 04 Jan 2026 => 04 Jan\n2026
            contents = contents.replace(/Jan\n2026/g, "Jan 2026");

            // general format is date\ntime\ntitle\ndescription\nlocation
            // except for cut page with a duplicate title, which appears before
            // the time

            var contents_lines = contents.split("\n");
            for (let i = contents_lines.length; i > 0; i--) {
                if (contents_lines[i - 1] == contents_lines[i]) {
                    console.debug(`Duplicate line: ${contents_lines[i]}`);
                    // remove the duplicate, shift index back
                    contents_lines.splice(i, 1);
                }
            }

            const misplaced_titles = [];
            for (let i = 1; i < contents_lines.length; i++) {
                if (contents_lines[i - 1].startsWith("Location:") && !contents_lines[i].startsWith("0")) {
                    console.warn(`Misplaced title: ${contents_lines[i]}`);
                    // subtract duplicate titles length since they will be removed
                    misplaced_titles.push(i);
                }
            }

            for (let i = 0; i < misplaced_titles.length; i++) {
                // pop array, subtracting index by number of removed items
                let index = misplaced_titles[i];
                let title = contents_lines[index];

                contents_lines.splice(index, 1);
                // now points to time
                contents_lines.splice(index + 2, 0, title);
            }

            const full_text = contents_lines.join("\n")
                .replace('â€“', '--'); // Mathopoly!
            // console.debug(full_text);
            const mega_regex = /(\d{2} \w+ \d{4})\n(\d{2}:\d{2} \w{2})\n((?:.*\n)+?)(?=Presented by)(Presented by:(?:.*\n)+?)(?=Location)(Location: .+)/g;
            const events = [];
            let match;
            const guess = document.getElementById("guess").checked;

            let matched_times = 0;
            while ((match = mega_regex.exec(full_text)) !== null) {
                const title = match[3].trim().replace(/\n/g, ' ');

                let end_time = null;
                if (resource_ready && guess) {
                    // match endtime -- very inefficiently
                    let day = parseInt(match[1].substring(0, 2));
                    for (let i = 0; i < data_json.length; i++) {
                        const event = data_json[i];

                        if (event["day"] == day && event["starttime"] == match[2].toLowerCase() && event["title"] == title) {
                            end_time = event["endtime"];
                            matched_times++;
                            break;
                        }
                    }
                }

                events.push({
                    date: match[1],
                    start_time: match[2],
                    end_time: end_time,
                    title: title,
                    presentedBy: match[4].replace('Presented by: ', '').trim().replace(/\n/g, ' '),
                    location: match[5].replace('Location: ', '').trim()
                });
            }

            console.debug(`Matched ${matched_times} out of ${events.length} event end times.`);


            generateLink(events);
            displayEvents(events);
        }



        document.getElementById("generate").onclick = parse_contents;
    </script>
</body>

</html>
